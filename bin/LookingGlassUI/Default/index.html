<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>LookingGlass</title>
<link rel="stylesheet" href="/static/LookingGlass.css" type="text/css"/>
<script type="application/javascript" src="/std/jquery.js"></script>
<script type="application/javascript">
$(document).ready(function() {
    // setup form to post info when 'Login' is pressed
    $("#LGLoginForm").submit(SendLoginRequest);

    // Major divisions in the content accordioning
    $('.LGSection').hide();
    $('#LGLogin').show();
    $('.LGSectionHeader').click(function() {
        $(this).next().toggle();
        return false;
    });

    // Start the timed functions
    TimerLoginStuff(true);
    TimerDataStuff();
});

// Login works by polling the viewer for the status of the user.
// If the user is logged in, we display this status and the user location.
// If not logged in, the user filled in fields and pressed 'login'
// which POSTs parameters to the viewer which change the user's
// login state.
var BASEURL='http://127.0.0.1:9144';
var loginTimerHandle;
// poll for the user's date. Initialize form if first GET.
function TimerLoginStuff(firstTime) {
    $.ajax({
        type: "GET",
        url: BASEURL + '/api/LLLP/status/',
        dataType: 'json',
        timeout: 5000,
        success: function(data, status) {
            if (status == 'success') {
                if (firstTime) InitializeLoginForm(data);
                UpdateLoginArea(data);
            }
        },
        error: function(xmlHTTPRequest, errorType) {
            UpdateLoginArea( {
                msg: {"value": "Lost connection to viewer"},
                loginstate: {"value": "logout"}
            });
        }
    });
            
    loginTimerHandle = setTimeout('TimerLoginStuff(false)', 3000);
};

// given a set of login status parameters, update login status area
function UpdateLoginArea(data) {
    $('#LGCurrentLogin td').empty();
    if (data['first'] != undefined) {
        $('#LGCurrentLogin td:nth-child(1)').append(data.first.value);
        $('#LGCurrentLogin td:nth-child(2)').append(data.last.value);
        $('#LGCurrentLogin td:nth-child(3)').append(data.currentgrid.value);
        $('#LGCurrentLogin td:nth-child(4)').append(data.currentsim.value);
        $('#LGCurrentLogin td:nth-child(5)').append(data.positionx.value);
        $('#LGCurrentLogin td:nth-child(6)').append(data.positiony.value);
        $('#LGCurrentLogin td:nth-child(7)').append(data.positionz.value);
    }

    $('#LGLoginMessage').empty();
    $('#LGLoginMessage').append(data.msg.value);

    if(data.loginstate.value == 'logout') {
        $("#LGLoginForm").show();
    }
    else {
        $("#LGLoginForm").hide();
    }
}

// Called the first time so we can pre-populate the form
function InitializeLoginForm(data) {
    $('#LGLoginForm input[name="LOGINFIRST"]').attr('value', data.first.value);
    $('#LGLoginForm input[name="LOGINLAST"]').attr('value', data.last.value);
    $('#LGLoginForm input[name="LOGINSIM"]').attr('value', data.sim.value);
    var selector = $('#LGLoginForm select[name="LOGINGRID"]');
    selector.empty();
    for (grid in data.possiblegrids.value) {
        var valu = data.possiblegrids.value[grid];
        selector.append('<option value="' + valu + '">' + valu + '</option>');
    }

}

// Called by login form 'submit' click
// Post the user's parameters to the viewer to login the user
function SendLoginRequest() {
    $.post(BASEURL + "/api/LLLP/connect/login", $('#LGLoginForm').serializeArray());
    return false;
}

// One of the sections is viewer statistics. Poll for the data.
var statTimerHandle;
function TimerDataStuff() {
    if ($('#LGQueueStats').is(':visible')) {
        $.getJSON(BASEURL+'/api/stats/workQueues', function(data, status) {
            if (status == 'success') {
                BuildBasicTable('#LGQueueStats', data, false);
            }
        });
        $.getJSON(BASEURL+'/api/stats/Renderer/detailStats', function(data, status) {
            if (status == 'success') {
                BuildBasicTable('#LGRendererStats', data, true);
            }
        });
        $.getJSON(BASEURL+'/api/stats/Renderer/ogreStats', function(data, status) {
            if (status == 'success') {
                BuildBasicTable('#LGOgreStats', data, true);
            }
        });
        $.getJSON(BASEURL+'/api/stats/Comm/stats', function(data, status) {
            if (status == 'success') {
                BuildBasicTable('#LGCommStats', data, true);
            }
        });
    }
    statTimerHandle = setTimeout('TimerDataStuff()', 2000);
};

function DebugLog(msg) {
    $("#DEBUG").append('<div>' + msg + '</div>');
    $("#DEBUG").show();
}

// build a table in the specified section.
// Clear whatever is there and refill it with the data.
// We presume the data is in the form:
//   {rowname: { col1: val, col2, val; ...}, ...)
function BuildBasicTable(sect, data, addRowName) {
    var sectID = MakeID(sect.substr(1))
    var tableID = MakeID(sectID + "-table")
    if ($('#' + tableID).length == 0) {
        // table does not exist. Build same
        // build an array of all the column names
        var columns = new Array();
        for (row in data) {
            for (col in data[row]) {
                if (columns[col] == undefined) {
                    columns[col] = col;
                }
                
            }
        }
        // create a table with td's with id's for cell addressing
        var buff = new StringBuffer();
        buff.append('<table id="' + tableID + '" class="LGStatsTable">');
        buff.append('<tr>');
        var headerClass = MakeID(sectID + '--header');
        if (addRowName) buff.append('<th class="' + headerClass + '"></th>');
        for (col in columns) {
            headerClass = MakeID(sectID + '-' + columns[col] + '-header');
            buff.append('<th class="' + headerClass +'">' + columns[col] + '</th>');
        }
        buff.append('</tr>');
        for (row in data) {
            buff.append('<tr>');
            if (addRowName) {
                buff.append('<td id="' + sectID + '-rowName-' + row + '">.</td>');
            }
            for (col in columns) {
                var cellID = MakeID(sectID + '-' + row + '-' + col);
                var cellClass = MakeID(sectID + '-' + col + '-class');
                buff.append('<td id="' + cellID + '" class="' + cellClass + '">.</td>');
            }
            buff.append('</tr>');
        }
        buff.append('</table>');
        $(sect).append(buff.toString());
    }
    // table exist. Fill its cells with the text data
    for (row in data) {
        $('#' + sectID + '-rowName-' + row).text(row);
        for (col in data[row]) {
            var cellID = MakeID(sectID + '-' + row + '-' + col);
            $('#' + cellID).text(data[row][col]);
        }
    }
}

// clean up ID so there are no dots
function MakeID(inID) {
    return inID.replace(/\./g, '-');
}

function StringBuffer() {
    this.__strings__ = new Array;
}
StringBuffer.prototype.append = function(str) {
    this.__strings__.push(str);
}
StringBuffer.prototype.toString = function() {
    return this.__strings__.join("");
}

</script>
</head>
<body id="LGBody">
<div id="LGHeader"></div>
<div id="LGContent">
<!-- ============================================== -->
<div class="LGSectionContainer">
<a class="LGSectionHeader" href="#">Connection</a>
<div id="LGLogin" class="LGSectionContent">

<div id="LGLoginMessage"></div>
<div id="LGCurrentLogin">
    <table>
        <tr>
            <th>First</th>
            <th>Last</th>
            <th>Grid</th>
            <th>Sim</th>
            <th>X</th>
            <th>Y</th>
            <th>Z</th>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </table>
</div>  <!-- LGCurrentLogin -->

<form id="LGLoginForm">
    <ul class="LGLogin">
        <li>
            <span class="label">First</span>
            <span class="value">
                <input type="text" name="LOGINFIRST"/>
            </span>
        </li>
        <li>
            <span class="label">Last</span>
            <span class="value">
                <input type="text" name="LOGINLAST"/>
            </span>
        </li>
        <li>
            <span class="label">Password</span>
            <span class="value">
                <input type="password" name="LOGINPASS"/>
            </span>
        </li>
        <li>
            <span class="label">Grid</span>
            <span class="value">
                <select size="1" name="LOGINGRID">
                    <option selected value="OSGrid">OSGrid</option>
                </select>
            </span>
        </li>
        <li>
            <span class="label">Sim</span>
            <span class="value">
                <input type="text" name="LOGINSIM"/>
            </span>
        </li>
    </ul>
    <span class="LGLoginSubmit">
        <input type="submit" value="Login"/>
    </span>
</div>  <!-- LGLogin -->
</div>  <!-- LGSectionContainer -->

<!-- ============================================== -->
<div class="LGSectionContainer">
<a class="LGSectionHeader" href="#">Chat</a>
<div id="LGChat" class="LGSection">
<textarea name="chattext" rows="20" cols="80"></textarea>
</div>  <!-- LGChat -->
</div>  <!-- LGSectionContainer -->

<!-- ============================================== -->
<div class="LGSectionContainer">
<a class="LGSectionHeader" href="#">Inventory</a>
<div id="LGInventory" class="LGSection">
<p>Look at all the stuff in my inventory</p>
</div>  <!-- LGInventory -->
</div>  <!-- LGSectionContainer -->

<!-- ============================================== -->
<div class="LGSectionContainer">
<a class="LGSectionHeader" href="#">Statistics</a>
<div id="LGStatistics" class="LGSection">
<div id="LGQueueStats">
<h1>WorkQueues</h1>
</div>  <!-- LGQueueStats -->
<div id="LGRendererStats">
<h1>Renderer</h1>
</div>  <!-- LGRendererStats -->
<div id="LGCommStats">
<h1>Communication Stats</h1>
</div>  <!-- LGCommStats -->
<div id="LGOgreStats">
<h1>Ogre Stats</h1>
</div>  <!-- LGOgreStats -->
<div><a href="/static/DefaultParameters.html">Parameter Defaults</a></div>
</div>  <!-- LGStatistics -->
</div>  <!-- LGSectionContainer -->

<!-- ============================================== -->
</div>  <!-- LGContent -->
<div id="DEBUG"></div>
<div id="LGFooter"></div>
</body>
</html>
